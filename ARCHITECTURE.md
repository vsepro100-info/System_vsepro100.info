# Архитектура

## Принципы
- Модули независимы.
- Взаимодействие между модулями — только через hooks и контракты.
- Core создаёт канонические сущности и источники правды (ref/CRM).
- Канонический жизненный цикл лидов использует только `core_ingest_event` и события `core_lead_*`.
- Каноническая сущность лида: `lead_entry` (internal-only CPT).

## Канон ролей и прав (системный уровень)
Каноническая иерархия ролей:
1) admin
2) speaker (trusted leader, расширенные возможности)
3) leader
4) partner
5) candidate

Правила:
- Отдельной роли "moderator" не существует.
- Роль speaker — системная доверенная роль и не ограничена вебинарами.
- Права управляются capabilities, а не введением новых ролей.

Примеры capabilities для speaker (не исчерпывающий список):
- webinar_manage_chat
- webinar_manage_status
- approve_users / approve_profiles (опционально, флагами)
- другие доверенные действия в будущем

## Канон вебинарного спикера (контекст, не роль)
- "Host / speaker" вебинара — это не роль.
- Это контекст вебинара: `webinar.speaker_id`.
- Все пользователи с ролью speaker сохраняют права модерации вне зависимости от того, кто указан в `webinar.speaker_id`.

## Канон владения чатом (недопустимы двойные чаты)
Источник чата зависит от `stream_type`:
- obs: внутренний чат включён, управляется speaker.
- zoom: внутренний чат выключен, источник истины — внешний чат платформы.
- telegram: внутренний чат выключен, источник истины — внешний чат группы.

## UX правила (высокоуровневые)
- Видимость внутреннего чата определяется только `stream_type`.
- Пользователь никогда не видит два чата для одного вебинара.
- Внешние платформы открываются в новой вкладке, страница платформы остаётся открытой.

## Канон CTA вебинара (системно утверждено)
- CTA — контекстный элемент вебинара, не постоянный и не "по времени".
- Состояние видимости CTA хранится в канонической сущности вебинара (`cta_visibility`).
- CTA скрыта по умолчанию (`hidden`) и показывается только по прямой команде спикера.
- Изменение видимости CTA допустимо только через Core hook `core_webinar_set_cta_visibility`.

## Pre-Dialog Behavioral Signals
- Auto-detected country is allowed as a context signal.
- Allowed sources for auto-detected country: IP, timezone, locale.
- Country-level only; city or precise location is explicitly forbidden.
- Priority: self-reported country overrides auto-detected country.
- Notes:
  - Used for chat flags.
  - Used for CRM context.
  - No interpretations are allowed.

## Legacy Runtime
- Legacy Runtime (vsepro100.info) не переносим.
- Используем его как эталон поведения и валидации решений.

## Сценарии клиентского вебинара
- Это отдельный класс сценариев.
- Целевая аудитория: лид (клиент), а не партнёр.
- Цель: посещаемость вебинара, удержание и действия после вебинара.
- Основаны на поведенческих событиях, а не только на времени.

Канонические клиентские события:
- webinar_registered
- webinar_entered
- webinar_left
- webinar_completed
- post_webinar_form_submitted

Требования разделения:
- Сценарии клиентского вебинара НЕ должны уведомлять партнёров.
- Партнёрские уведомления обрабатываются отдельно.

Примечание по Webinar Layer:
- Архитектурно утверждён.
- Аудит пройден.
- Реализация нейтральна; на текущем этапе — только события.
- Ссылка: WEBINAR_ARCHITECTURE.md.
