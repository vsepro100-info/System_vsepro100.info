# Архитектура

## Принципы
- Модули независимы.
- Взаимодействие между модулями — только через hooks и контракты.
- Core создаёт канонические сущности и источники правды (ref/CRM).
- Канонический жизненный цикл лидов использует только `core_ingest_event` и события `core_lead_*`.
- Каноническая сущность лида: `lead_entry` (internal-only CPT).

## Канон ролей и прав (системный уровень)
Каноническая иерархия ролей:
1) admin
2) speaker (trusted leader, расширенные возможности)
3) leader
4) partner
5) candidate

Правила:
- Отдельной роли "moderator" не существует.
- Роль speaker — системная доверенная роль и не ограничена вебинарами.
- Роль speaker назначается через WP Users (не через UI вебинара).
- Права управляются capabilities, а не введением новых ролей.

Примеры capabilities для speaker (не исчерпывающий список):
- webinar_manage_chat
- webinar_manage_status
- approve_users / approve_profiles (опционально, флагами)
- другие доверенные действия в будущем

## Канон вебинарного спикера (контекст, не роль)
- "Host / speaker" вебинара — это не роль.
- Это контекст вебинара: `webinar.speaker_id`.
- Все пользователи с ролью speaker сохраняют права модерации вне зависимости от того, кто указан в `webinar.speaker_id`.

## Канон владения чатом (недопустимы двойные чаты)
Источник чата зависит от `stream_type`:
- obs: внутренний чат включён, управляется speaker.
- zoom: внутренний чат выключен, источник истины — внешний чат платформы.
- telegram: внутренний чат выключен, источник истины — внешний чат группы.

## UX правила (высокоуровневые)
- Видимость внутреннего чата определяется только `stream_type`.
- Пользователь никогда не видит два чата для одного вебинара.
- Внешние платформы открываются в новой вкладке, страница платформы остаётся открытой.

## Канон админского UX вебинара
- `/admin_webinar/` по умолчанию открывается в режиме Speaker UI.
- Спикер видит только бизнес-поля и не может сломать конфигурацию вебинара.
- Технические поля спрятаны за настройками только для admin (иконка "gear").

## Канон CTA вебинара (системно утверждено)
- Вебинар хранит только гостевой CTA.
  - Текст по умолчанию: "Забронировать место на вебинар".
  - Ссылка по умолчанию: `/signup/`.
- Для авторизованных пользователей CTA из сущности не используется.
- UI всегда переопределяет CTA для авторизованных:
  - Текст: "Перейти в комнату вебинара".
  - Ссылка: `/account/webinar_room/`.
- Core не хранит и не мутирует "CTA для логина".
- Видимость CTA хранится в канонической сущности вебинара (`cta_visibility`).
- CTA скрыта по умолчанию (`hidden`) и показывается только по прямой команде спикера.
- Изменение видимости CTA допустимо только через Core hook `core_webinar_set_cta_visibility`.

## Webinars & Conversion Canon
1) Первичная цель вебинара
- Вебинар предназначен прежде всего для конверсии, а не обучения.
- Конверсия = переход к личному контакту с пригласившим / консультантом.

2) Каноническая воронка вебинара
- Точки входа:
  - внешние лендинги
  - расписание вебинаров
  - партнёрские ссылки
- Перед входом в комнату вебинара — обязательный логин.
- Комната вебинара существует внутри личного кабинета пользователя.

3) Принципы комнаты вебинара
- Внутри комнаты нет навигационных меню.
- Порядок фокуса:
  1) видео
  2) доверие
  3) CTA
- CTA:
  - единственный канонический CTA
  - контролируется спикером
  - скрыт по умолчанию
  - появляется в конце или по действию спикера
  - ведёт на `/account/contacts/`
  - открывается в новой вкладке

4) Участники и доверие
- Единый список участников для всех пользователей.
- Роли видимы всем (speaker / VIP / partner / guest).
- Флаги стран видимы всем.
- Структура рефералов и контактов не раскрывается.
- Цель: социальное доказательство и ощущение масштаба.

5) Непрерывность конверсии
- Пользователь всегда остаётся в контексте личного кабинета.
- CTA не прерывает поток вебинара.
- Контакт происходит после вебинара, не во время.

Правила канона:
- Источник истины — канон, а не история чата.
- Канон обязателен для всех модулей, связанных с вебинарами.

## Pre-Dialog Behavioral Signals
- Auto-detected country is allowed as a context signal.
- Allowed sources for auto-detected country: IP, timezone, locale.
- Country-level only; city or precise location is explicitly forbidden.
- Priority: self-reported country overrides auto-detected country.
- Notes:
  - Used for chat flags.
  - Used for CRM context.
  - No interpretations are allowed.

## Webinar Chat Module
- Внутренний чат комнаты вебинара — отдельный модуль с собственным UI, AJAX и хранением.

## Legacy Runtime
- Legacy Runtime (vsepro100.info) не переносим.
- Используем его как эталон поведения и валидации решений.

## Сценарии клиентского вебинара
- Это отдельный класс сценариев.
- Целевая аудитория: лид (клиент), а не партнёр.
- Цель: посещаемость вебинара, удержание и действия после вебинара.
- Основаны на поведенческих событиях, а не только на времени.

Канонические клиентские события:
- webinar_registered
- webinar_entered
- webinar_left
- webinar_completed
- post_webinar_form_submitted

Требования разделения:
- Сценарии клиентского вебинара НЕ должны уведомлять партнёров.
- Партнёрские уведомления обрабатываются отдельно.

Примечание по Webinar Layer:
- Архитектурно утверждён.
- Аудит пройден.
- Реализация нейтральна; на текущем этапе — только события.
- Ссылка: WEBINAR_ARCHITECTURE.md.
