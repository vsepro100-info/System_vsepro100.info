Status: CANON
Owner: Architect
Last updated: 2026-01-28

# Webinars — API & Integration Contracts

## Назначение
Зафиксировать канонические публичные интерфейсы Webinars для интеграций: REST‑контракты (где предусмотрено) и публичные hooks как webhook‑интерфейсы. Документ описывает **контракты** и границы, без реализации и приватных API.

## Источники и приоритет
- Канонические сущности: [CANON/DATA_MODEL](DATA_MODEL.md)
- Публичные контракты: [CANON/PUBLIC_CONTRACTS](PUBLIC_CONTRACTS.md)
- Карта событий/инициаторов: [CANON/EVENT_HOOK_MAP](EVENT_HOOK_MAP.md)
- Архитектурные ограничения: [CANON/ARCHITECTURE](ARCHITECTURE.md)
- Роли и разрешения: [CANON/PERMISSIONS_ROLES](PERMISSIONS_ROLES.md)

## Область действия
- **REST‑интерфейсы**: только там, где это явно предусмотрено каноном.
- **Webhooks/hooks**: публичные actions, разрешённые для внешних модулей.
- Все приватные эндпоинты/хуки исключены из контракта.

---

## 1) REST API (канонические интерфейсы)

### 1.1 Webinar Room State Sync (REST)
**Назначение:** синхронизация реального времени UI‑состояния комнаты вебинара.

**Метод/направление:** REST API (HTTP), клиент ↔ сервер. Конкретные URL‑пути **не зафиксированы** в CANON; любые частные пути считаются внутренними до публикации.

**Входные данные (минимум):**
- Идентификаторы канонических сущностей: `webinar_id`, `session_id` (если применимо), `lead_id`/`user_id`.
- Контекст актёра: `actor_id`, `role`, `timestamp`.
- Запрошенный/получаемый фрагмент UI‑состояния, не содержащий бизнес‑логики.

**Выходные данные:**
- Read‑only состояние комнаты вебинара, производное от Core и runtime:
  - `status` вебинара (из канонической сущности).
  - `cta_visibility`.
  - Атрибуты сессии участия (минимальные метки времени и прогресс для auto).

**Гарантии стабильности:**
- Канонический принцип: **realtime UI state синхронизируется исключительно через REST API**; `admin-ajax` запрещён. Изменение принципа возможно только через обновление CANON.
- Детали маршрутов/форматов считаются стабильными **только** после фиксации в CANON.

**Прямые запреты:**
- REST не может использоваться для изменения статуса или CTA напрямую — только через публичные hooks.

---

## 2) Public Webhooks / Hooks (actions)

> В контексте WordPress hooks трактуются как публичные webhook‑контракты. Направление указывается относительно модуля Webinars.

### 2.1 Управление жизненным циклом (входящие в Core)

#### `core_webinar_set_status` (action)
**Назначение:** канонический старт/стоп вебинара через Core.

**Метод/направление:** inbound hook → Core (инициатор: UI/интеграции).

**Входные данные:** `webinar_id`, `status` (`start` | `stop`), `context`.

**Выходные данные:** нет (факт обработки события).

**Гарантии стабильности:** имя и тип action стабильны; минимальный payload гарантирован.

#### `core_webinar_set_cta_visibility` (action)
**Назначение:** показать/скрыть CTA.

**Метод/направление:** inbound hook → Core (инициатор: UI).

**Входные данные:** `webinar_id`, `visible` (`true` | `false`), `context`.

**Выходные данные:** нет (факт обработки события).

**Гарантии стабильности:** имя и тип action стабильны; минимальный payload гарантирован.

---

### 2.2 Клиентские события Webinars (исходящие из Webinars)

#### `client_webinar_registered` (action)
**Назначение:** факт регистрации клиента на вебинар.

**Метод/направление:** outbound hook из Webinars.

**Входные данные:** `lead_id`, `webinar_id`, `webinar_type`, `slot_id`, `registered_at`, `source`.

**Выходные данные:** нет.

**Гарантии стабильности:** имя и тип action стабильны; событие фиксирует только факт регистрации.

#### `client_webinar_entered` (action)
**Назначение:** факт входа клиента в вебинарный опыт.

**Метод/направление:** outbound hook из Webinars.

**Входные данные:** `lead_id`, `webinar_id`, `timestamp`.

**Выходные данные:** нет.

**Гарантии стабильности:** имя и тип action стабильны; эмитируется один раз на сессию участия.

#### `client_webinar_left` (action)
**Назначение:** факт выхода клиента из вебинарного опыта.

**Метод/направление:** outbound hook из Webinars.

**Входные данные:** `lead_id`, `webinar_id`, `webinar_type`, `session_id`, `left_at`, `leave_reason`.

**Выходные данные:** нет.

**Гарантии стабильности:** имя и тип action стабильны; эмитируется один раз на сессию участия.

#### `client_webinar_completed` (action)
**Назначение:** факт завершения участия клиента.

**Метод/направление:** outbound hook из Webinars.

**Входные данные:** `lead_id`, `webinar_id`, `webinar_type`, `session_id`, `completed_at`.

**Выходные данные:** нет.

**Гарантии стабильности:** имя и тип action стабильны; не заменяет событие `client_webinar_left`.

#### `client_webinar_form_submitted` (action)
**Назначение:** факт отправки пост‑вебинарной формы.

**Метод/направление:** outbound hook из Webinars.

**Входные данные:** `lead_id`, `webinar_id`, `webinar_type`, `session_id`, `submitted_at`, `form_id`, `form_payload`.

**Выходные данные:** нет.

**Гарантии стабильности:** имя и тип action стабильны; допускается повторная эмиссия при повторной отправке.

#### `webinar_completed` (action)
**Назначение:** нормализованный downstream‑факт завершения участия.

**Метод/направление:** outbound hook из Webinars (нормализатор).

**Входные данные:** совпадают с `client_webinar_completed`.

**Выходные данные:** нет.

**Гарантии стабильности:** имя и тип action стабильны; событие не гарантирует источник эмиссии.

---

### 2.3 AutoWebinar runtime (входы/выходы)

#### Входящие события AutoWebinar (из Core)
- `core_user_registered`
- `core_user_login`
- `core_ref_context_resolved`

**Назначение:** получение канонических фактов Core для runtime AutoWebinar.

**Метод/направление:** inbound hooks → AutoWebinar.

**Входные данные:** `event_id`, `user_id`, `ref_id`, `timestamp`.

**Выходные данные:** нет.

**Гарантии стабильности:** имена и типы actions стабильны; payload минимален и каноничен.

#### Исходящие события AutoWebinar (внешние потребители)
- `autowebinar_session_created`
- `autowebinar_join`
- `autowebinar_progress`
- `autowebinar_cta_click`
- `autowebinar_completed`

**Назначение:** фиксация фактов AutoWebinar runtime.

**Метод/направление:** outbound hooks из AutoWebinar.

**Входные данные:** `event_id`, `user_id`, `ref_id`, `timestamp` (+ `progress` для `autowebinar_progress`).

**Выходные данные:** нет.

**Гарантии стабильности:** имена и типы actions стабильны; `progress` допустим только 25/50/75/100.

---

### 2.4 Интеграционные downstream‑события

#### `client_webinar_attendance_classified` (action)
**Назначение:** классификация посещения (attended/not_attended).

**Метод/направление:** outbound hook из Webinars (сервис классификации).

**Входные данные:** `lead_id`, `webinar_id`, `attended`, `timestamp`.

**Выходные данные:** нет.

**Гарантии стабильности:** имя и тип action стабильны; событие отражает каноническую классификацию.

#### `post_webinar_route` (action)
**Назначение:** маршрутизация post‑webinar сценария.

**Метод/направление:** outbound hook из Webinars (routing service).

**Входные данные:** `lead_id`, `webinar_id`, `attended`, `timestamp`, `route` (`attended` | `not_attended`).

**Выходные данные:** нет.

**Гарантии стабильности:** имя и тип action стабильны; `route` не переопределяется потребителями.

---

## 3) Аутентификация и авторизация (контрактный уровень)
- Контракты опираются на канонические роли: `organizer`, `speaker`, `moderator`, `attendee`, `guest`, `system`.
- Изменение статуса и CTA доступно **только** для `organizer`/`speaker` через публичные hooks.
- Внутренние состояния (`paused`, `archived`) доступны **только** роли `system`.
- Клиентские события (`client_webinar_*`) эмитируются из контекста `attendee`/`system` и не могут быть инициированы гостем.
- REST‑синхронизация требует аутентифицированного контекста и применяет те же роли/разрешения.

---

## 4) Ограничения и rate limits (концептуально)
- Любые события должны быть идемпотентны на уровне факта (одна регистрация/вход/выход/завершение на сессию).
- `client_webinar_entered`/`client_webinar_left`/`client_webinar_completed` эмитируются один раз на сессию участия.
- `autowebinar_progress` допускает только 25/50/75/100 и не может спамиться промежуточными значениями.
- REST‑синхронизация UI‑состояния должна быть задросселирована на уровне сессии/пользователя и не влияет на канонические сущности.

---

## 5) Гарантии стабильности
- Публичные hooks считаются стабильными в рамках CANON; любые изменения имён/типов/минимального payload — только через обновление CANON.
- Любые новые публичные hooks добавляются через обновление [CANON/PUBLIC_CONTRACTS](PUBLIC_CONTRACTS.md) и [CANON/EVENT_HOOK_MAP](EVENT_HOOK_MAP.md).
- REST‑контракты считаются стабильными только после фиксации в CANON.
