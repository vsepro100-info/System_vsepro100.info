Status: SPEC
Owner: Architect
Last updated: 2026-01-28

# Webinars — Flows & Events

## Канонические клиентские события вебинара

### Назначение
Документ фиксирует канонический контракт клиентских событий вебинара для сценариев. Он определяет имена событий, структуру полезной нагрузки верхнего уровня и правила эмиссии без привязки к реализации.

### Состояние реализации
- Реально реализовано в коде: `client_webinar_completed`, `client_webinar_entered`, `client_webinar_attendance_classified`.
- Запланировано / не реализовано: остальные события, перечисленные ниже.

### Канонические события (контракт)

#### 1) `client_webinar_registered` (запланировано / не реализовано)
**Смысл:** клиент зарегистрирован на вебинар (live или auto).

**Payload (верхний уровень):**
- `lead_id` — идентификатор лида (канонический идентификатор клиента).
- `webinar_id` — идентификатор вебинара.
- `webinar_type` — тип вебинара (`live` | `auto`).
- `slot_id` — идентификатор слота (только для live, если применимо).
- `registered_at` — отметка времени регистрации (как факт регистрации, без расписаний).
- `source` — источник регистрации (страница/канал/контекст).

**Правила эмиссии:**
- Эмитируется клиентским вебинарным слоем при успешной регистрации клиента.
- Должно быть единичным фактом регистрации на выбранный вебинар.

#### 2) `client_webinar_entered` (реально реализовано)
**Смысл:** клиент вошёл в вебинарный опыт (live или auto).

**Payload (верхний уровень):**
- `lead_id` — идентификатор лида (если доступен).
- `webinar_id` — идентификатор вебинара.
- `timestamp` — отметка времени входа (как факт входа).

**Правила эмиссии:**
- Эмитируется при фактическом входе клиента в вебинарный опыт.
- Эмитируется один раз на сессию участия.

#### 3) `client_webinar_left` (запланировано / не реализовано)
**Смысл:** клиент покинул вебинарный опыт (live или auto).

**Payload (верхний уровень):**
- `lead_id` — идентификатор лида.
- `webinar_id` — идентификатор вебинара.
- `webinar_type` — тип вебинара (`live` | `auto`).
- `session_id` — идентификатор сессии участия.
- `left_at` — отметка времени выхода (как факт выхода).
- `leave_reason` — причина выхода (например: `user_exit`, `session_end`, `network_loss`).

**Правила эмиссии:**
- Эмитируется при фактическом выходе клиента из вебинарного опыта.
- Эмитируется один раз на сессию участия.

#### 4) `client_webinar_completed` (реально реализовано)
**Смысл:** клиент завершил участие в вебинаре.

**Payload (верхний уровень):**
- `lead_id` — идентификатор лида.
- `webinar_id` — идентификатор вебинара.
- `webinar_type` — тип вебинара (`live` | `auto`).
- `session_id` — идентификатор сессии участия.
- `completed_at` — отметка времени завершения.

**Правила эмиссии:**
- Эмитируется, когда участие клиента считается завершённым по факту прохождения вебинара.
- Не заменяет событие выхода; может следовать после `client_webinar_left` при корректном завершении.

#### 5) `client_webinar_form_submitted` (запланировано / не реализовано)
**Смысл:** клиент отправил пост‑вебинарную форму.

**Payload (верхний уровень):**
- `lead_id` — идентификатор лида.
- `webinar_id` — идентификатор вебинара.
- `webinar_type` — тип вебинара (`live` | `auto`).
- `session_id` — идентификатор сессии участия.
- `submitted_at` — отметка времени отправки.
- `form_id` — идентификатор формы.
- `form_payload` — агрегированные ответы (структура определяется формой).

**Правила эмиссии:**
- Эмитируется при успешной отправке клиентом пост‑вебинарной формы.
- Допускается повторная эмиссия при повторной отправке, если форма допускает повторное заполнение.

#### 6) `client_webinar_attendance_classified` (реально реализовано)
**Смысл:** сервисная классификация факта посещения вебинара.

**Payload (верхний уровень):**
- `lead_id` — идентификатор лида.
- `webinar_id` — идентификатор вебинара.
- `attended` — флаг посещения (`true` | `false`).
- `timestamp` — отметка времени классификации.

**Правила эмиссии:**
- Эмитируется сервисным классификатором при завершении участия (`client_webinar_completed`) или при явной оценке.
- Если есть завершение участия → `attended = true`.
- Если есть вход и нет завершения участия → `attended = false`.
- Потребитель `post-webinar-routing-service` эмитирует `post_webinar_route` со статусом `attended` или `not_attended` и тем же payload.

### Общие гарантии и границы
- Канонические события предназначены для слоя сценариев клиентского вебинара и не несут партнёрской логики.
- Контракт фиксирует только факты поведения клиента и их минимальный контекст.
- Никаких временных сценариев, расписаний, таймеров или UI‑поведения здесь не определяется.
- Никаких партнёрских уведомлений или логики продаж не допускается.

### Явные исключения
- Любая реализация, код или обработчики.
- Любые тайминги сценариев и планирование событий.
- Любые описания экранов или UI‑логики.
- Любая партнёрская коммуникация или интеграции.

## Эмиттеры клиентских вебинарных событий (architecture‑only)

### Назначение
Документ фиксирует, какие реальные источники могут эмитировать канонические CLIENT_WEBINAR_EVENTS, и какие именно события им разрешены. Документ описывает только границы эмиссии и гарантии доставки фактов — без реализации, логики сценариев или потребителей.

### Состояние реализации
- Реально реализован единственный источник и событие: `client-webinar-tracker-v2` → `client_webinar_completed`.
- Любые другие события или эмиттеры в этом документе отмечены как запланированные / не реализованные.

### Принципы и границы
- Эмиттеры публикуют только факты клиентского поведения, без бизнес‑логики и интерпретаций.
- Канонические события используются как контракт для сценарного слоя; эмиттеры не знают о сценариях и потребителях.
- Эмиссия не описывает UI, экраны, тайминги и расписания.
- Любые новые эмиттеры добавляются только через обновление этого документа.

### Допустимые реальные источники и их события

**1) `client-webinar-tracker-v2`**

**Тип источника:** клиентский трекер участия в вебинаре (WordPress plugin).

**Разрешённые канонические события:**
- `client_webinar_completed` (реально реализовано)
- `client_webinar_entered` (запланировано / не реализовано)
- `client_webinar_form_submitted` (запланировано / не реализовано)

**Гарантии эмиссии:**
- Эмитирует факты входа/завершения/отправки формы без привязки к UI или сценариям.
- Повторная эмиссия допустима только если исходный трекер обеспечивает идемпотентность для конкретного факта (например, защита от дублей по маркерам у источника).
- Не принимает решений о маршрутизации, уведомлениях или последующих действиях.

### Канонические события без реальных эмиттеров (на текущий момент)
Следующие канонические события определены контрактом, но в системе не имеют утверждённого реального эмиттера:
- `client_webinar_registered`
- `client_webinar_left`

Добавление эмиттеров для этих событий требует отдельного архитектурного решения и обновления этого документа.

### Явные исключения
- Любая реализация, код или интеграции.
- Любые сценарии, бизнес‑правила, логика маршрутизации или потребители событий.
- Любые таймеры, расписания и временные триггеры.
- Любые описания UI/экранов или пользовательских потоков.

## Слой сценариев клиентского вебинара

### Назначение слоя
Слой сценариев клиентского вебинара определяет поведенческую оркестрацию для лида (клиента) вокруг вебинара: фиксацию ключевых событий, согласованную реакцию на них и безопасное управление клиентским маршрутом без привязки к партнёрским процессам или продажам. Слой опирается на канонические события и архитектурные принципы, сохраняя нейтральность реализации.

### Состояние реализации
- Слой сценариев клиентского вебинара — запланирован / не реализован.
- Любые действия и реакции, перечисленные ниже, являются целевыми и не работают в текущей системе.

### Входы (канонические события)
Слой принимает только канонические клиентские события вебинара:
- `client_webinar_registered` (запланировано / не реализовано)
- `client_webinar_entered` (запланировано / не реализовано)
- `client_webinar_left` (запланировано / не реализовано)
- `client_webinar_completed` (реально реализовано как событие, но слой сценариев не реализован)
- `client_webinar_form_submitted` (запланировано / не реализовано)

### Допустимые действия
Разрешены только действия, не выходящие за рамки клиентского сценария:
- Маршрутизация клиента между допустимыми состояниями сценария на основе событий.
- Клиентские напоминания, привязанные к событию и его контексту.
- Переходы между экранами клиентского вебинарного потока как реакция на события.

### Явные исключения
В слое сценариев клиентского вебинара строго запрещены:
- Любые партнёрские уведомления и партнёрская логика.
- Любая логика продаж, квалификации или назначения сделок.
- Любая реализация, код или UI‑описания.
- Любая временная логика и расписания.
- Любое поведение партнёрской стороны.

## Потребители действий сценариев клиентского вебинара

### Первый потребитель: Consumer маршрута клиента (Client Webinar Route Consumer)

**Назначение**
Первый потребитель действий сценариев принимает действия, эмитимые `Scenario Service` клиентского вебинара, и отвечает только за поддержание клиентского маршрута внутри сценария. Он фиксирует и применяет решения о маршрутизации и выборе допустимого экрана в рамках клиентского вебинарного потока, не выходя за пределы сценарного слоя.

**Ответственность и границы**
- Принимает сценарные действия и связывает их с состоянием маршрута клиента.
- Обновляет допустимое состояние маршрута на основе полученных действий.
- Определяет целевой экран/шаг клиентского вебинарного потока, если действие указывает на переход.
- Не интерпретирует события и не принимает решения вне уже сформированного действия сценария.

**Какие действия сценария потребляет**
Допустимые к потреблению действия, эмитимые `Scenario Service`:
- Маршрутизация клиента между допустимыми состояниями сценария на основе событий.
- Переходы между экранами клиентского вебинарного потока как реакция на события.

**Что ему разрешено делать**
- Привязывать действия сценария к состоянию маршрута клиента.
- Фиксировать новое состояние маршрута (маршрутная фиксация).
- Выбирать целевой экран/шаг клиентского вебинарного потока, если это явно указано в действии.

**Явные исключения (не‑цели)**
Потребитель **не** выполняет и **не** инициирует:
- Любые UI‑рендеринг или UI‑логику.
- Любые уведомления или напоминания, включая клиентские.
- Любую партнёрскую логику и партнёрские уведомления.
- Любую логику продаж, квалификации, CRM‑назначения или сделок.
- Любую временную логику, расписания или таймеры.
- Любые интеграции и реализацию кода.

Связанные документы:
- [SPEC/WEBINARS/OVERVIEW](OVERVIEW.md)
- [SPEC/WEBINARS/PAGES](PAGES.md)
- [SPEC/RUNBOOKS/TEST_RELEASE](../RUNBOOKS/TEST_RELEASE.md)
